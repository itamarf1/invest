{% extends "base.html" %}

{% block title %}Paper Trading - Investment Dashboard{% endblock %}

{% block nav_trading %}nav-active{% endblock %}

{% block content %}
<div class="trading-container">
    <h1>Paper Trading Dashboard</h1>

    <!-- Connection Status -->
    <div class="connection-status card" id="connectionStatus">
        <h3>Connection Status</h3>
        <div class="status-indicator">
            <span class="status-dot" id="statusDot"></span>
            <span id="connectionText">Loading...</span>
        </div>
    </div>

    <!-- Portfolio Overview -->
    <div class="portfolio-overview card">
        <h3>Portfolio Overview</h3>
        <div class="portfolio-stats" id="portfolioStats">
            <div class="stat">
                <label>Account Value</label>
                <span class="value" id="accountValue">$0.00</span>
            </div>
            <div class="stat">
                <label>Cash Balance</label>
                <span class="value" id="cashBalance">$0.00</span>
            </div>
            <div class="stat">
                <label>Buying Power</label>
                <span class="value" id="buyingPower">$0.00</span>
            </div>
            <div class="stat">
                <label>Day Change</label>
                <span class="value" id="dayChange">$0.00 (0.00%)</span>
            </div>
        </div>
    </div>

    <!-- Trading Mode Tabs -->
    <div class="trading-tabs">
        <button class="tab-btn active" data-tab="stocks">Stock Trading</button>
        <button class="tab-btn" data-tab="options">Options Trading</button>
        <button class="tab-btn" data-tab="strategies">Options Strategies</button>
        <button class="tab-btn" data-tab="analysis">Options Analysis</button>
    </div>

    <div class="trading-panels">
        <!-- Stock Trading Panel -->
        <div id="stocks-tab" class="tab-content active">
            <div class="order-panel card">
                <h3>Place Stock Order</h3>
                <form id="orderForm">
                    <div class="form-group">
                        <label for="symbol">Symbol</label>
                        <input type="text" id="symbol" name="symbol" placeholder="e.g., AAPL" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="quantity">Quantity</label>
                            <input type="number" id="quantity" name="quantity" min="1" value="10" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="orderSide">Side</label>
                            <select id="orderSide" name="side" required>
                                <option value="buy">Buy</option>
                                <option value="sell">Sell</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="orderType">Order Type</label>
                            <select id="orderType" name="order_type" required>
                                <option value="market">Market</option>
                                <option value="limit">Limit</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="limitPrice">Limit Price</label>
                            <input type="number" id="limitPrice" name="limit_price" step="0.01" placeholder="Optional">
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">Place Order</button>
                </form>
            </div>
        </div>

        <!-- Options Trading Panel -->
        <div id="options-tab" class="tab-content">
            <div class="options-trading-grid">
                <!-- Options Chain Panel -->
                <div class="options-chain-panel card">
                    <h3>Options Chain</h3>
                    <div class="options-search">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="optionsSymbol">Underlying Symbol</label>
                                <input type="text" id="optionsSymbol" placeholder="e.g., AAPL" required>
                            </div>
                            <div class="form-group">
                                <label for="optionsExpiry">Expiration Date</label>
                                <select id="optionsExpiry">
                                    <option value="">Select expiration...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <button type="button" class="btn btn-primary" onclick="loadOptionsChain()">Load Chain</button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="optionsChainContainer" class="options-chain-container">
                        <div class="loading-message">Enter symbol and select expiration to load options chain</div>
                    </div>
                </div>

                <!-- Options Order Panel -->
                <div class="options-order-panel card">
                    <h3>Place Options Order</h3>
                    <form id="optionsOrderForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="optionSymbol">Option Symbol</label>
                                <input type="text" id="optionSymbol" name="option_symbol" placeholder="e.g., AAPL240119C00185000" readonly>
                            </div>
                            <div class="form-group">
                                <label for="optionQuantity">Contracts</label>
                                <input type="number" id="optionQuantity" name="quantity" min="1" value="1" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="optionSide">Side</label>
                                <select id="optionSide" name="side" required>
                                    <option value="buy_to_open">Buy to Open</option>
                                    <option value="sell_to_open">Sell to Open</option>
                                    <option value="buy_to_close">Buy to Close</option>
                                    <option value="sell_to_close">Sell to Close</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="optionOrderType">Order Type</label>
                                <select id="optionOrderType" name="order_type" required>
                                    <option value="market">Market</option>
                                    <option value="limit">Limit</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="optionLimitPrice">Limit Price</label>
                                <input type="number" id="optionLimitPrice" name="limit_price" step="0.01" placeholder="Optional">
                            </div>
                            <div class="form-group">
                                <label for="optionStrategy">Strategy</label>
                                <select id="optionStrategy" name="strategy">
                                    <option value="single">Single Option</option>
                                    <option value="covered_call">Covered Call</option>
                                    <option value="protective_put">Protective Put</option>
                                    <option value="straddle">Straddle</option>
                                    <option value="strangle">Strangle</option>
                                </select>
                            </div>
                        </div>
                        
                        <div id="optionDetails" class="option-details">
                            <!-- Option details will be populated here -->
                        </div>
                        
                        <button type="submit" class="btn btn-primary">Place Options Order</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Options Strategies Panel -->
        <div id="strategies-tab" class="tab-content">
            <div class="strategies-grid">
                <div class="strategy-card card" data-strategy="covered_call">
                    <h4>Covered Call</h4>
                    <p>Own 100 shares + sell call option</p>
                    <div class="strategy-info">
                        <span class="outlook">Neutral to Bullish</span>
                        <span class="max-profit">Limited</span>
                        <span class="max-loss">Substantial</span>
                    </div>
                    <button class="btn btn-small" onclick="executeStrategy('covered_call')">Execute</button>
                </div>

                <div class="strategy-card card" data-strategy="protective_put">
                    <h4>Protective Put</h4>
                    <p>Own shares + buy put for protection</p>
                    <div class="strategy-info">
                        <span class="outlook">Bullish</span>
                        <span class="max-profit">Unlimited</span>
                        <span class="max-loss">Limited</span>
                    </div>
                    <button class="btn btn-small" onclick="executeStrategy('protective_put')">Execute</button>
                </div>

                <div class="strategy-card card" data-strategy="long_straddle">
                    <h4>Long Straddle</h4>
                    <p>Buy call + buy put (same strike)</p>
                    <div class="strategy-info">
                        <span class="outlook">High Volatility</span>
                        <span class="max-profit">Unlimited</span>
                        <span class="max-loss">Premium Paid</span>
                    </div>
                    <button class="btn btn-small" onclick="executeStrategy('long_straddle')">Execute</button>
                </div>

                <div class="strategy-card card" data-strategy="iron_condor">
                    <h4>Iron Condor</h4>
                    <p>4-leg neutral strategy</p>
                    <div class="strategy-info">
                        <span class="outlook">Low Volatility</span>
                        <span class="max-profit">Net Premium</span>
                        <span class="max-loss">Limited</span>
                    </div>
                    <button class="btn btn-small" onclick="executeStrategy('iron_condor')">Execute</button>
                </div>

                <div class="strategy-card card" data-strategy="butterfly">
                    <h4>Long Butterfly</h4>
                    <p>Buy 1, sell 2, buy 1 (different strikes)</p>
                    <div class="strategy-info">
                        <span class="outlook">Neutral</span>
                        <span class="max-profit">Limited</span>
                        <span class="max-loss">Premium Paid</span>
                    </div>
                    <button class="btn btn-small" onclick="executeStrategy('butterfly')">Execute</button>
                </div>

                <div class="strategy-card card" data-strategy="calendar_spread">
                    <h4>Calendar Spread</h4>
                    <p>Sell near-term, buy far-term</p>
                    <div class="strategy-info">
                        <span class="outlook">Neutral</span>
                        <span class="max-profit">Limited</span>
                        <span class="max-loss">Premium Paid</span>
                    </div>
                    <button class="btn btn-small" onclick="executeStrategy('calendar_spread')">Execute</button>
                </div>
            </div>
        </div>

        <!-- Options Analysis Panel -->
        <div id="analysis-tab" class="tab-content">
            <div class="analysis-grid">
                <div class="options-calculator card">
                    <h3>Options Calculator</h3>
                    <form id="optionsCalculatorForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="calcSymbol">Symbol</label>
                                <input type="text" id="calcSymbol" placeholder="AAPL" required>
                            </div>
                            <div class="form-group">
                                <label for="calcStrike">Strike Price</label>
                                <input type="number" id="calcStrike" step="0.01" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="calcExpiry">Days to Expiry</label>
                                <input type="number" id="calcExpiry" min="1" value="30" required>
                            </div>
                            <div class="form-group">
                                <label for="calcVolatility">Implied Volatility (%)</label>
                                <input type="number" id="calcVolatility" step="0.01" value="25" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="calcRiskFree">Risk-Free Rate (%)</label>
                                <input type="number" id="calcRiskFree" step="0.01" value="5" required>
                            </div>
                            <div class="form-group">
                                <label for="calcOptionType">Option Type</label>
                                <select id="calcOptionType">
                                    <option value="call">Call</option>
                                    <option value="put">Put</option>
                                </select>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">Calculate</button>
                    </form>
                    
                    <div id="calculatorResults" class="calculator-results" style="display: none;">
                        <h4>Black-Scholes Results</h4>
                        <div class="results-grid">
                            <div class="result-item">
                                <label>Theoretical Price:</label>
                                <span id="theoreticalPrice">$0.00</span>
                            </div>
                            <div class="result-item">
                                <label>Delta:</label>
                                <span id="delta">0.00</span>
                            </div>
                            <div class="result-item">
                                <label>Gamma:</label>
                                <span id="gamma">0.00</span>
                            </div>
                            <div class="result-item">
                                <label>Theta:</label>
                                <span id="theta">0.00</span>
                            </div>
                            <div class="result-item">
                                <label>Vega:</label>
                                <span id="vega">0.00</span>
                            </div>
                            <div class="result-item">
                                <label>Rho:</label>
                                <span id="rho">0.00</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="volatility-surface card">
                    <h3>Implied Volatility Analysis</h3>
                    <div class="form-group">
                        <label for="volSymbol">Symbol</label>
                        <input type="text" id="volSymbol" placeholder="AAPL">
                        <button class="btn btn-small" onclick="loadVolatilityData()">Load Volatility</button>
                    </div>
                    
                    <div id="volatilityChart" class="chart-container">
                        <canvas id="volChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Auto Trading Panel (kept from original) -->

        <!-- Auto Trading Panel -->
        <div class="auto-trade-panel card">
            <h3>Auto Trading</h3>
            <p>Execute trades based on sentiment-enhanced signals</p>
            
            <form id="autoTradeForm">
                <div class="form-group">
                    <label for="autoSymbol">Symbol</label>
                    <input type="text" id="autoSymbol" name="symbol" placeholder="e.g., AAPL" required>
                </div>
                
                <button type="submit" class="btn btn-secondary">Execute Auto Trade</button>
            </form>
            
            <div id="autoTradeResult" class="trade-result" style="display: none;"></div>
        </div>
    </div>

    <!-- Current Positions -->
    <div class="positions-panel card">
        <h3>Current Positions</h3>
        <div class="table-container">
            <table id="positionsTable" class="positions-table">
                <thead>
                    <tr>
                        <th>Symbol</th>
                        <th>Quantity</th>
                        <th>Avg Price</th>
                        <th>Current Price</th>
                        <th>Market Value</th>
                        <th>P&L</th>
                        <th>P&L %</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="positionsBody">
                    <tr>
                        <td colspan="8" class="no-data">No positions found</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Order History -->
    <div class="orders-panel card">
        <h3>Order History</h3>
        <div class="orders-filter">
            <select id="orderStatusFilter">
                <option value="all">All Orders</option>
                <option value="filled">Filled</option>
                <option value="open">Open</option>
                <option value="canceled">Canceled</option>
            </select>
            <button class="btn btn-small" onclick="loadOrders()">Refresh</button>
        </div>
        
        <div class="table-container">
            <table id="ordersTable" class="orders-table">
                <thead>
                    <tr>
                        <th>Symbol</th>
                        <th>Side</th>
                        <th>Quantity</th>
                        <th>Status</th>
                        <th>Fill Price</th>
                        <th>Submitted</th>
                    </tr>
                </thead>
                <tbody id="ordersBody">
                    <tr>
                        <td colspan="6" class="no-data">Loading orders...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Performance Metrics -->
    <div class="performance-panel card">
        <h3>Performance Metrics</h3>
        <div class="metrics-grid" id="performanceMetrics">
            <div class="metric">
                <label>Total Return</label>
                <span class="value" id="totalReturn">0.00%</span>
            </div>
            <div class="metric">
                <label>Sharpe Ratio</label>
                <span class="value" id="sharpeRatio">0.00</span>
            </div>
            <div class="metric">
                <label>Max Drawdown</label>
                <span class="value" id="maxDrawdown">0.00%</span>
            </div>
            <div class="metric">
                <label>Win Rate</label>
                <span class="value" id="winRate">0.0%</span>
            </div>
            <div class="metric">
                <label>Total Trades</label>
                <span class="value" id="totalTrades">0</span>
            </div>
            <div class="metric">
                <label>Profit Factor</label>
                <span class="value" id="profitFactor">0.00</span>
            </div>
        </div>
    </div>
</div>

<style>
.trading-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
}

/* Trading Tabs */
.trading-tabs {
    display: flex;
    gap: 2px;
    margin-bottom: 20px;
    background: #f1f5f9;
    border-radius: 8px;
    padding: 4px;
}

.tab-btn {
    flex: 1;
    padding: 12px 20px;
    background: transparent;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s ease;
}

.tab-btn:hover {
    background: #e2e8f0;
}

.tab-btn.active {
    background: white;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    color: var(--primary-color);
}

/* Tab Content */
.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

.trading-panels {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin: 20px 0;
}

/* Options Trading Specific Styles */
.options-trading-grid {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 20px;
}

.options-chain-container {
    max-height: 600px;
    overflow-y: auto;
    margin-top: 15px;
}

.options-chain-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
}

.options-chain-table th,
.options-chain-table td {
    padding: 8px 4px;
    text-align: center;
    border: 1px solid #e5e7eb;
}

.options-chain-table th {
    background: #f8f9fa;
    font-weight: 600;
    position: sticky;
    top: 0;
}

.calls-section {
    background: #f0f9f0;
}

.puts-section {
    background: #fff0f0;
}

.option-row:hover {
    background: #f3f4f6;
    cursor: pointer;
}

.strike-price {
    font-weight: 600;
    background: #fafafa !important;
}

.options-search {
    margin-bottom: 15px;
}

.loading-message {
    text-align: center;
    padding: 40px;
    color: #6b7280;
    font-style: italic;
}

/* Strategy Cards */
.strategies-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
}

.strategy-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    cursor: pointer;
}

.strategy-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.strategy-card h4 {
    color: var(--primary-color);
    margin-bottom: 8px;
}

.strategy-card p {
    color: #6b7280;
    font-size: 14px;
    margin-bottom: 15px;
}

.strategy-info {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 15px;
}

.strategy-info span {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 500;
    text-align: center;
}

.outlook {
    background: #dbeafe;
    color: #1d4ed8;
}

.max-profit {
    background: #dcfce7;
    color: #166534;
}

.max-loss {
    background: #fef2f2;
    color: #dc2626;
}

/* Analysis Grid */
.analysis-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

.options-calculator {
    min-height: 500px;
}

.calculator-results {
    margin-top: 20px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 6px;
}

.results-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-top: 15px;
}

.result-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #e5e7eb;
}

.result-item label {
    font-weight: 500;
    color: #374151;
}

.result-item span {
    font-weight: 600;
    color: var(--primary-color);
}

.volatility-surface {
    min-height: 500px;
}

.chart-container {
    height: 300px;
    margin-top: 15px;
}

/* Option Details */
.option-details {
    padding: 15px;
    background: #f8f9fa;
    border-radius: 6px;
    margin-bottom: 15px;
    font-size: 14px;
}

.option-details h4 {
    margin-bottom: 10px;
    color: var(--primary-color);
}

.option-details .detail-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
}

.option-details .detail-row:last-child {
    margin-bottom: 0;
}

/* Clickable styles */
.clickable {
    cursor: pointer;
    transition: background-color 0.2s ease;
}

.clickable:hover {
    background-color: #e5e7eb !important;
    font-weight: 600;
}

.connection-status .status-indicator {
    display: flex;
    align-items: center;
    gap: 10px;
}

.status-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #dc3545;
}

.status-dot.connected {
    background: #28a745;
}

.status-dot.simulated {
    background: #ffc107;
}

.portfolio-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-top: 15px;
}

.stat {
    text-align: center;
}

.stat label {
    display: block;
    font-size: 0.9em;
    color: #666;
    margin-bottom: 5px;
}

.stat .value {
    font-size: 1.5em;
    font-weight: 600;
    color: #333;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
}

.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
}

.form-group input,
.form-group select {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

.btn {
    padding: 10px 20px;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
}

.btn:hover {
    background: #0056b3;
}

.btn-secondary {
    background: #6c757d;
}

.btn-secondary:hover {
    background: #545b62;
}

.btn-small {
    padding: 5px 10px;
    font-size: 12px;
}

.trade-result {
    margin-top: 15px;
    padding: 10px;
    border-radius: 4px;
    border: 1px solid #ddd;
}

.trade-result.success {
    background: #d4edda;
    border-color: #c3e6cb;
    color: #155724;
}

.trade-result.error {
    background: #f8d7da;
    border-color: #f5c6cb;
    color: #721c24;
}

.table-container {
    overflow-x: auto;
}

.positions-table,
.orders-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
}

.positions-table th,
.positions-table td,
.orders-table th,
.orders-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #ddd;
}

.positions-table th,
.orders-table th {
    background: #f8f9fa;
    font-weight: 600;
}

.no-data {
    text-align: center !important;
    color: #666;
    font-style: italic;
}

.orders-filter {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-bottom: 15px;
}

.orders-filter select {
    padding: 5px 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 20px;
    margin-top: 15px;
}

.metric {
    text-align: center;
}

.metric label {
    display: block;
    font-size: 0.9em;
    color: #666;
    margin-bottom: 5px;
}

.metric .value {
    font-size: 1.3em;
    font-weight: 600;
    color: #333;
}

.positive {
    color: #28a745 !important;
}

.negative {
    color: #dc3545 !important;
}

@media (max-width: 768px) {
    .trading-panels {
        grid-template-columns: 1fr;
    }
    
    .form-row {
        grid-template-columns: 1fr;
    }
    
    .portfolio-stats,
    .metrics-grid {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script>
let portfolioData = {};

// Load portfolio status
async function loadPortfolioStatus() {
    try {
        showLoading();
        const response = await axios.get('/api/portfolio-status');
        portfolioData = response.data;
        
        updateConnectionStatus(portfolioData);
        updatePortfolioStats(portfolioData);
        updatePositionsTable(portfolioData.positions);
        
    } catch (error) {
        console.error('Error loading portfolio:', error);
        showError('Failed to load portfolio data');
    } finally {
        hideLoading();
    }
}

// Update connection status
function updateConnectionStatus(data) {
    const statusDot = document.getElementById('statusDot');
    const connectionText = document.getElementById('connectionText');
    
    if (data.connected) {
        statusDot.className = 'status-dot connected';
        connectionText.textContent = data.connection_type;
    } else {
        statusDot.className = 'status-dot simulated';
        connectionText.textContent = data.connection_type;
    }
}

// Update portfolio stats
function updatePortfolioStats(data) {
    document.getElementById('accountValue').textContent = formatCurrency(data.account_value);
    document.getElementById('cashBalance').textContent = formatCurrency(data.cash_balance);
    document.getElementById('buyingPower').textContent = formatCurrency(data.buying_power);
    
    const dayChange = data.day_change || 0;
    const dayChangePct = data.day_change_pct || 0;
    const dayChangeEl = document.getElementById('dayChange');
    
    dayChangeEl.textContent = `${formatCurrency(dayChange)} (${dayChangePct.toFixed(2)}%)`;
    dayChangeEl.className = `value ${dayChange >= 0 ? 'positive' : 'negative'}`;
}

// Update positions table
function updatePositionsTable(positions) {
    const tbody = document.getElementById('positionsBody');
    
    if (!positions || positions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="no-data">No positions found</td></tr>';
        return;
    }
    
    tbody.innerHTML = positions.map(pos => `
        <tr>
            <td><strong>${pos.symbol}</strong></td>
            <td>${pos.quantity}</td>
            <td>${formatCurrency(pos.avg_entry_price)}</td>
            <td>${formatCurrency(pos.current_price)}</td>
            <td>${formatCurrency(pos.market_value)}</td>
            <td class="${pos.unrealized_pnl >= 0 ? 'positive' : 'negative'}">
                ${formatCurrency(pos.unrealized_pnl)}
            </td>
            <td class="${pos.unrealized_pnl_pct >= 0 ? 'positive' : 'negative'}">
                ${pos.unrealized_pnl_pct.toFixed(2)}%
            </td>
            <td>
                <button class="btn btn-small" onclick="sellPosition('${pos.symbol}', ${pos.quantity})">
                    Sell
                </button>
            </td>
        </tr>
    `).join('');
}

// Load orders
async function loadOrders() {
    try {
        const status = document.getElementById('orderStatusFilter').value;
        const response = await axios.get(`/api/orders?status=${status}&limit=20`);
        
        updateOrdersTable(response.data.orders);
    } catch (error) {
        console.error('Error loading orders:', error);
        showError('Failed to load orders');
    }
}

// Update orders table
function updateOrdersTable(orders) {
    const tbody = document.getElementById('ordersBody');
    
    if (!orders || orders.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="no-data">No orders found</td></tr>';
        return;
    }
    
    tbody.innerHTML = orders.map(order => `
        <tr>
            <td><strong>${order.symbol}</strong></td>
            <td class="${order.side === 'buy' ? 'positive' : 'negative'}">
                ${order.side.toUpperCase()}
            </td>
            <td>${order.quantity}</td>
            <td>
                <span class="status-${order.status}">${order.status.toUpperCase()}</span>
            </td>
            <td>${order.avg_fill_price ? formatCurrency(order.avg_fill_price) : '-'}</td>
            <td>${order.submitted_at ? new Date(order.submitted_at).toLocaleDateString() : '-'}</td>
        </tr>
    `).join('');
}

// Load performance metrics
async function loadPerformanceMetrics() {
    try {
        const response = await axios.get('/api/performance-metrics');
        const metrics = response.data;
        
        document.getElementById('totalReturn').textContent = `${metrics.total_return_pct?.toFixed(2) || 0}%`;
        document.getElementById('sharpeRatio').textContent = metrics.sharpe_ratio?.toFixed(2) || '0.00';
        document.getElementById('maxDrawdown').textContent = `${metrics.max_drawdown?.toFixed(2) || 0}%`;
        document.getElementById('winRate').textContent = `${metrics.win_rate?.toFixed(1) || 0}%`;
        document.getElementById('totalTrades').textContent = metrics.total_trades || 0;
        document.getElementById('profitFactor').textContent = metrics.profit_factor?.toFixed(2) || '0.00';
        
        // Apply colors
        const totalReturnEl = document.getElementById('totalReturn');
        totalReturnEl.className = `value ${(metrics.total_return_pct || 0) >= 0 ? 'positive' : 'negative'}`;
        
        const maxDrawdownEl = document.getElementById('maxDrawdown');
        maxDrawdownEl.className = 'value negative';
        
    } catch (error) {
        console.error('Error loading performance metrics:', error);
    }
}

// Place order
document.getElementById('orderForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const orderData = Object.fromEntries(formData);
    
    // Convert quantity to number
    orderData.quantity = parseInt(orderData.quantity);
    
    // Add limit_price only if order_type is limit and price is provided
    if (orderData.order_type === 'limit' && orderData.limit_price) {
        orderData.limit_price = parseFloat(orderData.limit_price);
    } else {
        delete orderData.limit_price;
    }
    
    try {
        showLoading();
        const response = await axios.post('/api/place-order', orderData);
        
        showSuccess(response.data.message);
        e.target.reset();
        
        // Refresh portfolio and orders
        setTimeout(() => {
            loadPortfolioStatus();
            loadOrders();
        }, 1000);
        
    } catch (error) {
        const errorMsg = error.response?.data?.detail || 'Failed to place order';
        showError(errorMsg);
    } finally {
        hideLoading();
    }
});

// Auto trade
document.getElementById('autoTradeForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const tradeData = Object.fromEntries(formData);
    
    try {
        showLoading();
        const response = await axios.post('/api/auto-trade', tradeData);
        const result = response.data;
        
        const resultDiv = document.getElementById('autoTradeResult');
        resultDiv.style.display = 'block';
        resultDiv.className = 'trade-result';
        
        let resultHtml = `
            <h4>Auto Trade Result for ${result.symbol}</h4>
            <p><strong>Signal:</strong> ${result.signal} (Confidence: ${(result.confidence * 100).toFixed(0)}%)</p>
            <p><strong>Sentiment:</strong> ${result.sentiment_label} (${result.sentiment_score?.toFixed(3) || 0})</p>
        `;
        
        if (result.order_executed) {
            resultDiv.classList.add('success');
            resultHtml += `<p><strong>✅ ${result.message}</strong></p>`;
            
            // Refresh data
            setTimeout(() => {
                loadPortfolioStatus();
                loadOrders();
            }, 1000);
        } else {
            resultDiv.classList.add('error');
            resultHtml += `<p><strong>ℹ️ ${result.message}</strong></p>`;
        }
        
        resultDiv.innerHTML = resultHtml;
        
    } catch (error) {
        const resultDiv = document.getElementById('autoTradeResult');
        resultDiv.style.display = 'block';
        resultDiv.className = 'trade-result error';
        resultDiv.innerHTML = `<p><strong>Error:</strong> ${error.response?.data?.detail || 'Failed to execute auto trade'}</p>`;
    } finally {
        hideLoading();
    }
});

// Sell position helper
function sellPosition(symbol, quantity) {
    if (confirm(`Sell all ${quantity} shares of ${symbol}?`)) {
        document.getElementById('symbol').value = symbol;
        document.getElementById('quantity').value = quantity;
        document.getElementById('orderSide').value = 'sell';
        
        // Scroll to order form
        document.getElementById('orderForm').scrollIntoView({ behavior: 'smooth' });
    }
}

// Order status filter change
document.getElementById('orderStatusFilter').addEventListener('change', loadOrders);

// Utility functions
function formatCurrency(value) {
    if (value === null || value === undefined) return '$0.00';
    return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD'
    }).format(value);
}

function showLoading() {
    document.getElementById('loadingOverlay').style.display = 'flex';
}

function hideLoading() {
    document.getElementById('loadingOverlay').style.display = 'none';
}

function showSuccess(message) {
    // Simple success notification
    const notification = document.createElement('div');
    notification.className = 'notification success';
    notification.textContent = message;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #d4edda;
        color: #155724;
        padding: 15px 20px;
        border-radius: 4px;
        border: 1px solid #c3e6cb;
        z-index: 1000;
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 5000);
}

function showError(message) {
    // Simple error notification
    const notification = document.createElement('div');
    notification.className = 'notification error';
    notification.textContent = message;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #f8d7da;
        color: #721c24;
        padding: 15px 20px;
        border-radius: 4px;
        border: 1px solid #f5c6cb;
        z-index: 1000;
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 5000);
}

// Tab switching functionality
function initializeTabs() {
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');

    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            const targetTab = button.dataset.tab;
            
            // Remove active class from all buttons and contents
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            
            // Add active class to clicked button and corresponding content
            button.classList.add('active');
            document.getElementById(`${targetTab}-tab`).classList.add('active');
        });
    });
}

// Options Chain Functionality
let currentOptionsData = {};

async function loadOptionsChain() {
    const symbol = document.getElementById('optionsSymbol').value.toUpperCase();
    const expiry = document.getElementById('optionsExpiry').value;
    
    if (!symbol) {
        showError('Please enter a symbol');
        return;
    }
    
    try {
        showLoading();
        
        // First load available expiration dates
        const expiryResponse = await axios.get(`/api/options/expirations/${symbol}`);
        const expirations = expiryResponse.data.expirations;
        
        const expirySelect = document.getElementById('optionsExpiry');
        expirySelect.innerHTML = '<option value="">Select expiration...</option>';
        expirations.forEach(exp => {
            expirySelect.innerHTML += `<option value="${exp}">${exp}</option>`;
        });
        
        if (expiry) {
            // Load options chain for selected expiry
            const chainResponse = await axios.get(`/api/options/chain/${symbol}/${expiry}`);
            displayOptionsChain(chainResponse.data);
        }
        
    } catch (error) {
        console.error('Error loading options:', error);
        showError(error.response?.data?.detail || 'Failed to load options chain');
    } finally {
        hideLoading();
    }
}

function displayOptionsChain(data) {
    currentOptionsData = data;
    const container = document.getElementById('optionsChainContainer');
    
    if (!data.calls || !data.puts) {
        container.innerHTML = '<div class="loading-message">No options data available for this expiration</div>';
        return;
    }
    
    const calls = data.calls;
    const puts = data.puts;
    const strikes = [...new Set([...calls.map(c => c.strike), ...puts.map(p => p.strike)])].sort((a, b) => a - b);
    
    let tableHtml = `
        <table class="options-chain-table">
            <thead>
                <tr>
                    <th colspan="6" class="calls-section">CALLS</th>
                    <th class="strike-price">Strike</th>
                    <th colspan="6" class="puts-section">PUTS</th>
                </tr>
                <tr class="calls-section">
                    <th>Last</th>
                    <th>Bid</th>
                    <th>Ask</th>
                    <th>Volume</th>
                    <th>OI</th>
                    <th>IV</th>
                    <th class="strike-price">Price</th>
                    <th>IV</th>
                    <th>OI</th>
                    <th>Volume</th>
                    <th>Ask</th>
                    <th>Bid</th>
                    <th>Last</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    strikes.forEach(strike => {
        const call = calls.find(c => c.strike === strike);
        const put = puts.find(p => p.strike === strike);
        
        tableHtml += `
            <tr class="option-row">
                <td class="calls-section ${call ? 'clickable' : ''}" onclick="${call ? `selectOption('${call.symbol}', 'call', ${strike})` : ''}">${call ? call.last_price || '-' : '-'}</td>
                <td class="calls-section">${call ? call.bid || '-' : '-'}</td>
                <td class="calls-section">${call ? call.ask || '-' : '-'}</td>
                <td class="calls-section">${call ? call.volume || '-' : '-'}</td>
                <td class="calls-section">${call ? call.open_interest || '-' : '-'}</td>
                <td class="calls-section">${call ? (call.implied_volatility * 100).toFixed(1) + '%' : '-'}</td>
                <td class="strike-price">$${strike}</td>
                <td class="puts-section">${put ? (put.implied_volatility * 100).toFixed(1) + '%' : '-'}</td>
                <td class="puts-section">${put ? put.open_interest || '-' : '-'}</td>
                <td class="puts-section">${put ? put.volume || '-' : '-'}</td>
                <td class="puts-section">${put ? put.ask || '-' : '-'}</td>
                <td class="puts-section">${put ? put.bid || '-' : '-'}</td>
                <td class="puts-section ${put ? 'clickable' : ''}" onclick="${put ? `selectOption('${put.symbol}', 'put', ${strike})` : ''}">${put ? put.last_price || '-' : '-'}</td>
            </tr>
        `;
    });
    
    tableHtml += '</tbody></table>';
    container.innerHTML = tableHtml;
}

function selectOption(optionSymbol, type, strike) {
    document.getElementById('optionSymbol').value = optionSymbol;
    
    // Populate option details
    const detailsDiv = document.getElementById('optionDetails');
    const option = currentOptionsData[type === 'call' ? 'calls' : 'puts'].find(opt => opt.symbol === optionSymbol);
    
    if (option) {
        detailsDiv.innerHTML = `
            <h4>Option Details</h4>
            <div class="detail-row">
                <span>Type:</span>
                <span>${type.toUpperCase()}</span>
            </div>
            <div class="detail-row">
                <span>Strike:</span>
                <span>$${strike}</span>
            </div>
            <div class="detail-row">
                <span>Last Price:</span>
                <span>$${option.last_price || 'N/A'}</span>
            </div>
            <div class="detail-row">
                <span>Bid/Ask:</span>
                <span>$${option.bid}/$${option.ask}</span>
            </div>
            <div class="detail-row">
                <span>Implied Volatility:</span>
                <span>${(option.implied_volatility * 100).toFixed(1)}%</span>
            </div>
            <div class="detail-row">
                <span>Delta:</span>
                <span>${option.delta?.toFixed(3) || 'N/A'}</span>
            </div>
            <div class="detail-row">
                <span>Gamma:</span>
                <span>${option.gamma?.toFixed(3) || 'N/A'}</span>
            </div>
            <div class="detail-row">
                <span>Theta:</span>
                <span>${option.theta?.toFixed(3) || 'N/A'}</span>
            </div>
        `;
        
        // Set suggested limit price
        const midPrice = (parseFloat(option.bid || 0) + parseFloat(option.ask || 0)) / 2;
        if (midPrice > 0) {
            document.getElementById('optionLimitPrice').value = midPrice.toFixed(2);
        }
    }
}

// Options Calculator
document.getElementById('optionsCalculatorForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const calcData = Object.fromEntries(formData);
    
    try {
        showLoading();
        const response = await axios.post('/api/options/calculate', {
            symbol: calcData.calcSymbol,
            strike: parseFloat(calcData.calcStrike),
            expiry_days: parseInt(calcData.calcExpiry),
            volatility: parseFloat(calcData.calcVolatility) / 100,
            risk_free_rate: parseFloat(calcData.calcRiskFree) / 100,
            option_type: calcData.calcOptionType
        });
        
        const results = response.data;
        displayCalculatorResults(results);
        
    } catch (error) {
        console.error('Error calculating options:', error);
        showError(error.response?.data?.detail || 'Failed to calculate option price');
    } finally {
        hideLoading();
    }
});

function displayCalculatorResults(results) {
    document.getElementById('theoreticalPrice').textContent = `$${results.theoretical_price?.toFixed(2) || 'N/A'}`;
    document.getElementById('delta').textContent = results.delta?.toFixed(4) || 'N/A';
    document.getElementById('gamma').textContent = results.gamma?.toFixed(4) || 'N/A';
    document.getElementById('theta').textContent = results.theta?.toFixed(4) || 'N/A';
    document.getElementById('vega').textContent = results.vega?.toFixed(4) || 'N/A';
    document.getElementById('rho').textContent = results.rho?.toFixed(4) || 'N/A';
    
    document.getElementById('calculatorResults').style.display = 'block';
}

// Strategy Execution
async function executeStrategy(strategyName) {
    const symbol = prompt(`Enter the underlying symbol for ${strategyName} strategy:`, 'AAPL');
    if (!symbol) return;
    
    try {
        showLoading();
        const response = await axios.post('/api/options/execute-strategy', {
            strategy: strategyName,
            symbol: symbol.toUpperCase(),
            quantity: 1
        });
        
        showSuccess(`${strategyName} strategy executed successfully for ${symbol}`);
        
        // Refresh portfolio
        setTimeout(() => {
            loadPortfolioStatus();
            loadOrders();
        }, 1000);
        
    } catch (error) {
        console.error('Error executing strategy:', error);
        showError(error.response?.data?.detail || `Failed to execute ${strategyName} strategy`);
    } finally {
        hideLoading();
    }
}

// Options Order Form
document.getElementById('optionsOrderForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const orderData = Object.fromEntries(formData);
    
    orderData.quantity = parseInt(orderData.quantity);
    if (orderData.limit_price) {
        orderData.limit_price = parseFloat(orderData.limit_price);
    }
    
    try {
        showLoading();
        const response = await axios.post('/api/options/place-order', orderData);
        
        showSuccess(response.data.message);
        e.target.reset();
        document.getElementById('optionDetails').innerHTML = '';
        
        // Refresh portfolio and orders
        setTimeout(() => {
            loadPortfolioStatus();
            loadOrders();
        }, 1000);
        
    } catch (error) {
        const errorMsg = error.response?.data?.detail || 'Failed to place options order';
        showError(errorMsg);
    } finally {
        hideLoading();
    }
});

// Volatility Analysis
let volChart = null;

async function loadVolatilityData() {
    const symbol = document.getElementById('volSymbol').value.toUpperCase();
    if (!symbol) {
        showError('Please enter a symbol');
        return;
    }
    
    try {
        showLoading();
        const response = await axios.get(`/api/options/volatility-surface/${symbol}`);
        displayVolatilityChart(response.data);
        
    } catch (error) {
        console.error('Error loading volatility data:', error);
        showError(error.response?.data?.detail || 'Failed to load volatility data');
    } finally {
        hideLoading();
    }
}

function displayVolatilityChart(data) {
    const ctx = document.getElementById('volChart').getContext('2d');
    
    if (volChart) {
        volChart.destroy();
    }
    
    if (!data.volatility_surface || data.volatility_surface.length === 0) {
        ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
        ctx.fillText('No volatility data available', 10, 50);
        return;
    }
    
    const chartData = data.volatility_surface.map(item => ({
        x: item.strike,
        y: item.implied_volatility * 100
    }));
    
    volChart = new Chart(ctx, {
        type: 'line',
        data: {
            datasets: [{
                label: `${data.symbol} Implied Volatility`,
                data: chartData,
                borderColor: '#2563eb',
                backgroundColor: 'rgba(37, 99, 235, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    type: 'linear',
                    title: {
                        display: true,
                        text: 'Strike Price'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Implied Volatility (%)'
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                }
            }
        }
    });
}

// Initialize page
document.addEventListener('DOMContentLoaded', () => {
    initializeTabs();
    loadPortfolioStatus();
    loadOrders();
    loadPerformanceMetrics();
});

// Auto refresh every 30 seconds
setInterval(() => {
    loadPortfolioStatus();
    loadPerformanceMetrics();
}, 30000);
</script>
{% endblock %}