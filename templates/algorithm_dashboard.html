<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Algorithm Performance Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .performance-card {
            transition: transform 0.2s;
        }
        .performance-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .metric-positive {
            color: #198754;
        }
        .metric-negative {
            color: #dc3545;
        }
        .algorithm-type-badge {
            font-size: 0.75rem;
        }
        .heat-map-cell {
            border: 1px solid #dee2e6;
            text-align: center;
            vertical-align: middle;
            min-height: 40px;
            font-size: 0.875rem;
        }
        .loading-spinner {
            display: none;
        }
        .chart-container {
            height: 400px;
            margin-bottom: 20px;
        }
        .comparison-table {
            font-size: 0.9rem;
        }
        .benchmark-comparison {
            background: linear-gradient(90deg, #e3f2fd 0%, #ffffff 100%);
        }
    </style>
</head>
<body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">üìä Algorithm Performance Dashboard</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/login">Account</a>
                <a class="nav-link" href="/">Main Dashboard</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <h2>Algorithm Performance Dashboard</h2>
                    <div>
                        <button class="btn btn-primary me-2" onclick="runAnalysis()">
                            <span id="analysis-btn-text">üîÑ Run Analysis</span>
                            <div class="loading-spinner spinner-border spinner-border-sm ms-2" role="status"></div>
                        </button>
                        <div class="btn-group">
                            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                View
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#overview" onclick="showSection('overview')">Overview</a></li>
                                <li><a class="dropdown-item" href="#comparison" onclick="showSection('comparison')">Comparison</a></li>
                                <li><a class="dropdown-item" href="#heatmap" onclick="showSection('heatmap')">Heat Map</a></li>
                                <li><a class="dropdown-item" href="#risk" onclick="showSection('risk')">Risk Analysis</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <p class="text-muted">Comprehensive performance tracking and comparison of all trading algorithms</p>
            </div>
        </div>

        <!-- Overview Section -->
        <div id="overview-section" class="dashboard-section">
            <!-- Key Metrics -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h3 id="total-algorithms" class="text-primary">-</h3>
                            <p class="card-text">Algorithms Tracked</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h3 id="avg-return" class="text-success">-</h3>
                            <p class="card-text">Average Return</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h3 id="avg-sharpe" class="text-info">-</h3>
                            <p class="card-text">Average Sharpe</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h3 id="avg-drawdown" class="text-warning">-</h3>
                            <p class="card-text">Avg Max Drawdown</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Top Performers -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5>üèÜ Top Performers by Return</h5>
                        </div>
                        <div class="card-body">
                            <div id="top-performers-list">
                                <p class="text-muted">Loading top performers...</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5>üìà Algorithm Type Performance</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="algorithmTypeChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Performance Distribution -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5>üìä Return Distribution</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="returnDistributionChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Comparison Section -->
        <div id="comparison-section" class="dashboard-section" style="display: none;">
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5>üîç Algorithm Comparison</h5>
                            <div>
                                <select class="form-select" id="comparison-metric" onchange="updateComparison()">
                                    <option value="total_return">Total Return</option>
                                    <option value="sharpe_ratio">Sharpe Ratio</option>
                                    <option value="max_drawdown">Max Drawdown</option>
                                    <option value="win_rate">Win Rate</option>
                                    <option value="volatility">Volatility</option>
                                </select>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped comparison-table">
                                    <thead>
                                        <tr>
                                            <th>Rank</th>
                                            <th>Algorithm</th>
                                            <th>Type</th>
                                            <th>Symbol</th>
                                            <th>Total Return</th>
                                            <th>Sharpe Ratio</th>
                                            <th>Max Drawdown</th>
                                            <th>Win Rate</th>
                                            <th>Trades</th>
                                            <th>Volatility</th>
                                            <th>vs Benchmark</th>
                                        </tr>
                                    </thead>
                                    <tbody id="comparison-table-body">
                                        <tr><td colspan="11" class="text-center text-muted">Loading comparison data...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Heat Map Section -->
        <div id="heatmap-section" class="dashboard-section" style="display: none;">
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5>üî• Performance Heat Map</h5>
                            <div>
                                <select class="form-select" id="heatmap-metric" onchange="updateHeatMap()">
                                    <option value="total_return">Total Return</option>
                                    <option value="sharpe_ratio">Sharpe Ratio</option>
                                    <option value="max_drawdown">Max Drawdown</option>
                                    <option value="win_rate">Win Rate</option>
                                    <option value="volatility">Volatility</option>
                                </select>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="heatmap-container">
                                <p class="text-muted text-center">Loading heat map...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Risk Analysis Section -->
        <div id="risk-section" class="dashboard-section" style="display: none;">
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5>‚ö†Ô∏è Risk-Return Scatter</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="riskReturnChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5>üìâ Drawdown Analysis</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="drawdownChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alerts -->
        <div id="alerts-container" class="position-fixed top-0 end-0 p-3" style="z-index: 1050;"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentData = {};
        let charts = {};

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
            showSection('overview');
        });

        async function loadDashboardData() {
            try {
                // Load overview data
                const overviewResponse = await fetch('/api/algorithm-dashboard/overview');
                if (overviewResponse.ok) {
                    const overviewData = await overviewResponse.json();
                    updateOverview(overviewData);
                }

                // Load comparison data
                const comparisonResponse = await fetch('/api/algorithm-dashboard/algorithms/comparison');
                if (comparisonResponse.ok) {
                    const comparisonData = await comparisonResponse.json();
                    currentData.comparison = comparisonData;
                    updateComparison();
                }

                // Load performance matrix
                const matrixResponse = await fetch('/api/algorithm-dashboard/performance-matrix');
                if (matrixResponse.ok) {
                    const matrixData = await matrixResponse.json();
                    currentData.matrix = matrixData;
                    updateHeatMap();
                }

                // Load risk analysis
                const riskResponse = await fetch('/api/algorithm-dashboard/risk-analysis');
                if (riskResponse.ok) {
                    const riskData = await riskResponse.json();
                    currentData.risk = riskData;
                    updateRiskAnalysis();
                }

            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showAlert('danger', 'Error loading dashboard data: ' + error.message);
            }
        }

        function updateOverview(data) {
            const summary = data.dashboard_overview;
            
            if (summary && summary.overall_statistics) {
                const stats = summary.overall_statistics;
                
                document.getElementById('total-algorithms').textContent = summary.total_algorithms_tracked || '0';
                document.getElementById('avg-return').textContent = (stats.average_return || 0).toFixed(2) + '%';
                document.getElementById('avg-sharpe').textContent = (stats.average_sharpe_ratio || 0).toFixed(2);
                document.getElementById('avg-drawdown').textContent = (stats.average_max_drawdown || 0).toFixed(2) + '%';
                
                // Update top performers
                updateTopPerformers(summary.top_performers);
                
                // Update algorithm type chart
                updateAlgorithmTypeChart(summary.algorithm_type_performance);
                
                // Create return distribution chart
                createReturnDistributionChart(summary);
            }
        }

        function updateTopPerformers(topPerformers) {
            const container = document.getElementById('top-performers-list');
            
            if (!topPerformers) {
                container.innerHTML = '<p class="text-muted">No performance data available</p>';
                return;
            }

            let html = '';
            
            Object.entries(topPerformers).forEach(([category, performer]) => {
                const categoryName = category.replace('_', ' ').split(' ').map(word => 
                    word.charAt(0).toUpperCase() + word.slice(1)
                ).join(' ');
                
                html += `
                    <div class="mb-3 p-2 border rounded">
                        <h6 class="text-primary mb-1">${categoryName}</h6>
                        <div class="d-flex justify-content-between">
                            <span class="fw-bold">${performer.name}</span>
                            <span class="${performer.return >= 0 ? 'text-success' : 'text-danger'}">
                                ${performer.return ? performer.return.toFixed(2) : '0.00'}%
                            </span>
                        </div>
                        <small class="text-muted">
                            Sharpe: ${performer.sharpe_ratio ? performer.sharpe_ratio.toFixed(2) : 'N/A'}
                        </small>
                    </div>
                `;
            });
            
            container.innerHTML = html || '<p class="text-muted">No top performers data</p>';
        }

        function updateAlgorithmTypeChart(typePerformance) {
            const ctx = document.getElementById('algorithmTypeChart').getContext('2d');
            
            if (charts.algorithmType) {
                charts.algorithmType.destroy();
            }
            
            if (!typePerformance) return;
            
            const labels = Object.keys(typePerformance).map(type => 
                type.replace('_', ' ').split(' ').map(word => 
                    word.charAt(0).toUpperCase() + word.slice(1)
                ).join(' ')
            );
            
            const data = Object.values(typePerformance).map(perf => perf.average_return || 0);
            const colors = [
                'rgba(255, 99, 132, 0.8)',
                'rgba(54, 162, 235, 0.8)',
                'rgba(255, 205, 86, 0.8)',
                'rgba(75, 192, 192, 0.8)',
                'rgba(153, 102, 255, 0.8)',
                'rgba(255, 159, 64, 0.8)'
            ];
            
            charts.algorithmType = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Average Return (%)',
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderColor: colors.slice(0, labels.length).map(color => color.replace('0.8', '1')),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Return (%)'
                            }
                        }
                    }
                }
            });
        }

        function createReturnDistributionChart(summary) {
            // This would require individual algorithm returns
            // For now, we'll create a simple placeholder
        }

        function updateComparison() {
            const metric = document.getElementById('comparison-metric').value;
            const tbody = document.getElementById('comparison-table-body');
            
            if (!currentData.comparison || !currentData.comparison.algorithms) {
                tbody.innerHTML = '<tr><td colspan="11" class="text-center text-muted">No comparison data available</td></tr>';
                return;
            }
            
            // Sort by selected metric if different from current
            let algorithms = [...currentData.comparison.algorithms];
            
            let html = '';
            algorithms.forEach((algo, index) => {
                const returnClass = algo.total_return >= 0 ? 'metric-positive' : 'metric-negative';
                const drawdownClass = algo.max_drawdown <= -10 ? 'metric-negative' : '';
                
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td><strong>${algo.name || 'Unknown'}</strong></td>
                        <td><span class="badge bg-secondary algorithm-type-badge">${algo.type || 'N/A'}</span></td>
                        <td>${algo.symbol || 'N/A'}</td>
                        <td class="${returnClass}">${(algo.total_return || 0).toFixed(2)}%</td>
                        <td>${(algo.sharpe_ratio || 0).toFixed(2)}</td>
                        <td class="${drawdownClass}">${(algo.max_drawdown || 0).toFixed(2)}%</td>
                        <td>${(algo.win_rate || 0).toFixed(1)}%</td>
                        <td>${algo.total_trades || 0}</td>
                        <td>${(algo.volatility || 0).toFixed(2)}%</td>
                        <td class="${(algo.excess_return || 0) >= 0 ? 'metric-positive' : 'metric-negative'}">
                            ${(algo.excess_return || 0) >= 0 ? '+' : ''}${(algo.excess_return || 0).toFixed(2)}%
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        function updateHeatMap() {
            const metric = document.getElementById('heatmap-metric').value;
            const container = document.getElementById('heatmap-container');
            
            if (!currentData.matrix || !currentData.matrix.matrix_data) {
                container.innerHTML = '<p class="text-muted text-center">No heat map data available</p>';
                return;
            }
            
            const matrixData = currentData.matrix.matrix_data;
            const algorithmTypes = currentData.matrix.algorithm_types || [];
            const symbols = currentData.matrix.symbols || [];
            
            if (algorithmTypes.length === 0 || symbols.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">Insufficient data for heat map</p>';
                return;
            }
            
            // Create heat map table
            let html = '<table class="table table-bordered mb-0"><thead><tr><th>Algorithm / Symbol</th>';
            
            symbols.forEach(symbol => {
                html += `<th class="text-center">${symbol}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            algorithmTypes.forEach(algoType => {
                html += `<tr><th>${algoType.replace('_', ' ').toUpperCase()}</th>`;
                
                symbols.forEach(symbol => {
                    const cellData = matrixData[algoType] && matrixData[algoType][symbol];
                    const value = cellData ? cellData[metric] || 0 : 0;
                    
                    // Color coding based on metric
                    let cellClass = 'heat-map-cell';
                    let textClass = '';
                    
                    if (metric === 'total_return' || metric === 'sharpe_ratio') {
                        if (value > 10) cellClass += ' bg-success text-white';
                        else if (value > 0) cellClass += ' bg-light-success text-dark';
                        else if (value < -10) cellClass += ' bg-danger text-white';
                        else if (value < 0) cellClass += ' bg-light-danger text-dark';
                    } else if (metric === 'max_drawdown') {
                        if (value < -20) cellClass += ' bg-danger text-white';
                        else if (value < -10) cellClass += ' bg-warning text-dark';
                        else cellClass += ' bg-light text-dark';
                    }
                    
                    html += `<td class="${cellClass}">${value.toFixed(1)}${metric.includes('rate') || metric.includes('return') || metric.includes('drawdown') ? '%' : ''}</td>`;
                });
                
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function updateRiskAnalysis() {
            if (!currentData.risk || !currentData.risk.risk_analysis) {
                return;
            }
            
            createRiskReturnChart();
            createDrawdownChart();
        }

        function createRiskReturnChart() {
            const ctx = document.getElementById('riskReturnChart').getContext('2d');
            
            if (charts.riskReturn) {
                charts.riskReturn.destroy();
            }
            
            const riskData = currentData.risk.risk_analysis;
            if (!riskData || riskData.length === 0) return;
            
            const data = riskData.map(algo => ({
                x: algo.volatility || 0,
                y: algo.total_return || 0,
                label: algo.name
            }));
            
            charts.riskReturn = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Algorithms',
                        data: data,
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Volatility (%)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Return (%)'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.raw.label}: Risk ${context.parsed.x.toFixed(1)}%, Return ${context.parsed.y.toFixed(1)}%`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function createDrawdownChart() {
            const ctx = document.getElementById('drawdownChart').getContext('2d');
            
            if (charts.drawdown) {
                charts.drawdown.destroy();
            }
            
            const riskData = currentData.risk.risk_analysis;
            if (!riskData || riskData.length === 0) return;
            
            const labels = riskData.map(algo => algo.name.substring(0, 15) + '...');
            const drawdowns = riskData.map(algo => Math.abs(algo.max_drawdown || 0));
            
            charts.drawdown = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Max Drawdown (%)',
                        data: drawdowns,
                        backgroundColor: 'rgba(255, 99, 132, 0.6)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Drawdown (%)'
                            }
                        }
                    }
                }
            });
        }

        async function runAnalysis() {
            const btn = document.getElementById('analysis-btn-text');
            const spinner = document.querySelector('.loading-spinner');
            
            btn.textContent = 'Running Analysis...';
            spinner.style.display = 'inline-block';
            
            try {
                const response = await fetch('/api/algorithm-dashboard/run-analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        lookback_days: 365
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showAlert('success', 'Analysis started successfully! Results will be available in 2-5 minutes.');
                    
                    // Reload data after a delay
                    setTimeout(() => {
                        loadDashboardData();
                    }, 10000); // 10 seconds
                } else {
                    throw new Error('Failed to start analysis');
                }
            } catch (error) {
                showAlert('danger', 'Error starting analysis: ' + error.message);
            } finally {
                btn.textContent = 'üîÑ Run Analysis';
                spinner.style.display = 'none';
            }
        }

        function showSection(sectionName) {
            // Hide all sections
            const sections = document.querySelectorAll('.dashboard-section');
            sections.forEach(section => {
                section.style.display = 'none';
            });
            
            // Show selected section
            document.getElementById(sectionName + '-section').style.display = 'block';
            
            // Update active nav
            document.querySelectorAll('.dropdown-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`a[onclick="showSection('${sectionName}')"]`).classList.add('active');
        }

        function showAlert(type, message) {
            const alertsContainer = document.getElementById('alerts-container');
            const alertId = 'alert-' + Date.now();
            
            const alertHtml = `
                <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            alertsContainer.insertAdjacentHTML('beforeend', alertHtml);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                const alert = document.getElementById(alertId);
                if (alert) {
                    alert.remove();
                }
            }, 5000);
        }

        // Auto-refresh data every 5 minutes
        setInterval(loadDashboardData, 5 * 60 * 1000);
    </script>
</body>
</html>